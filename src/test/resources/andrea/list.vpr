field elem: Int
field next: Ref

predicate list(this: Ref) {
  acc(this.elem) && acc(this.next) &&
  (this.next != null ==> list(this.next))
}

function listLength(l:Ref) : Int
  requires list(l)
  ensures  result > 0
{ 
  unfolding list(l) in l.next == null ? 1 : 1 + listLength(l.next) 
}

method appendList(this: Ref, e: Int)
  requires list(this)
  requires 0 <= e && e < 100
  ensures  list(this)
{
  unfold list(this)
  assume 0 <= this.elem && this.elem < 100

  if (this.next == null) {
    var n: Ref

    n := new(elem, next)
    n.elem := e
    n.next := null
    this.next := n

    fold list(n)
  } else {
    appendList(this.next, e)
  }
  fold list(this)
}
