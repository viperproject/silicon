field elem: Int
field next: Ref

predicate list(this: Ref) {
  acc(this.elem) && acc(this.next) &&
  (this.next != null ==> list(this.next))
}

function listLength(l:Ref) : Int
  requires list(l)
  ensures  result > 0
{ 
  unfolding list(l) in l.next == null ? 1 : 1 + listLength(l.next) 
}

method appendList1(this: Ref, e: Int)
  requires list(this) // TODO ake: imprecise @irrelevant("Explicit")(list(this))
  requires @irrelevant("Explicit")(0 <= e && e < 100)
  ensures  list(this)
{
  // @irrelevant("Implicit") TODO ake: imprecise
  unfold list(this)
  @irrelevant("Explicit")
  assume 0 <= this.elem && this.elem < 100

  if (this.next == null) { // TODO ake: imprecise @irrelevant("PathCondition")(this.next == null)
    var n: Ref

    @dependency("Implicit")
    n := new(elem, next)
    @irrelevant("Implicit")
    n.elem := e
    @dependency("Implicit")
    n.next := null
    @irrelevant("Implicit")
    this.next := n
    @testAssertion("Implicit")
    fold list(n)
  } else {
    appendList1(this.next, e)
  }

  fold list(this)
}

method appendList2(this: Ref, e: Int)
  requires @dependency("Explicit")(list(this))
  requires @dependency("Explicit")(0 <= e && e < 100)
  ensures  list(this)
{
  @dependency("Implicit")
  unfold list(this)
  @irrelevant("Explicit")
  assume 0 <= this.elem && this.elem < 100

  if (@dependency("PathCondition")(this.next == null)) {
    var n: Ref

    @irrelevant("Implicit")
    n := new(elem, next)
    @irrelevant("Implicit")
    n.elem := e
    @irrelevant("Implicit")
    n.next := null
    @irrelevant("Implicit")
    this.next := n
    @irrelevant("Implicit")
    fold list(n)
  } else {
    @testAssertion("Implicit")
    appendList2(this.next, e)
  }

  fold list(this)
}

method appendListFull(this: Ref, e: Int)
  requires @dependency("Explicit")(list(this))
  requires @dependency("Explicit")(0 <= e && e < 100)
  ensures  list(this)
{
  @dependency("Implicit")
  unfold list(this)
  @irrelevant("Explicit")
  assume 0 <= this.elem && this.elem < 100

  if (@dependency("PathCondition")(this.next == null)) {
    var n: Ref

    @dependency("Implicit")
    n := new(elem, next)
    @irrelevant("Implicit")
    n.elem := e
    @dependency("Implicit")
    n.next := null
    @dependency("Implicit")
    this.next := n
    @dependency("Implicit")
    fold list(n)
  } else {
    @dependency("Implicit")
    appendListFull(this.next, e)
  }

  @testAssertion("Implicit")
  fold list(this)
}
