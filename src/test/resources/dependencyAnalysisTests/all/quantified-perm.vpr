field f: Int
field first : Ref
field second : Ref



method quantifiedWritePerm(nodes: Set[Ref], x: Ref)
  requires @irrelevant("Explicit")(forall n:Ref :: { n.first } n in nodes ==>
    acc(n.first) && 
    (n.first != null ==> n.first in nodes))
  requires @dependency("Explicit")(forall n:Ref :: { n.second } n in nodes ==>
    acc(n.second) && 
    (n.second != null ==> n.second in nodes))
  requires @dependency("Explicit")(x in nodes)
{
  var y : Ref
  if(@dependency("PathCondition")(x.second != null)) {
    @dependency("Implicit")
    y := x.second // permissions covered by preconditions
    @dependency("Implicit")
    y.second := y
    @testAssertion("Explicit")
    assert x.second.second == x.second
  }
}

method quantifiedSum(nodes: Set[Ref], x: Ref)
  requires @dependency("Explicit")(forall n:Ref :: { n.first } n in nodes ==>
    acc(n.first) && 
    (n.first != null ==> n.first in nodes))
  requires @dependency("Explicit")(forall n:Ref :: { n.f } n in nodes ==>
    acc(n.f) && 0 <= n.f && n.f <= 100)
  requires @dependency("Explicit")(x in nodes)
{
  var a: Int
  @dependency("Implicit")
  a := x.f
  if(@dependency("PathCondition")(x.first != null)) {
    @dependency("Implicit")
    a := a + x.first.f
  }
  @testAssertion("Explicit")
  assert a >= 0
}

