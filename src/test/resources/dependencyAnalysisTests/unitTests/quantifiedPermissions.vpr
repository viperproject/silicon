field f: Int

method quantifiedPerm1(xs: Seq[Ref]) {
  assume @dependency("Explicit")(|xs| > 5)
  inhale @dependency("Explicit")(forall x: Ref :: x in xs ==> acc(x.f))

  inhale xs[0] != xs[1]

  // $PrecisionTest: $READ_WRITE=xs[0].f,xs[1].f $INVARIANT=|xs|>0 $ACC_INVARIANT=forall$_$x:Ref::x$_$in$_$xs$_$==>$_$acc(x.f)

  @testAssertion()
  xs[0].f := 10
}

method quantifiedPerm2(xs: Seq[Ref]) {
  assume @dependency("Explicit")(|xs| > 5)
  inhale @dependency("Explicit")(forall x: Ref :: x in xs ==> acc(x.f))

  inhale xs[0] != xs[4]

  // $PrecisionTest: $READ_WRITE=xs[0].f,xs[4].f $INVARIANT=|xs|>4 $ACC_INVARIANT=forall$_$x:Ref::x$_$in$_$xs$_$==>$_$acc(x.f)

  @testAssertion()
  xs[0].f := xs[1].f + xs[4].f
}

method quantifiedPerm3(xs: Seq[Ref], y: Ref) {
  assume @dependency("Explicit")(|xs| > 5)
  inhale @dependency("Explicit")(forall x: Ref :: x in xs ==> acc(x.f))
  inhale @dependency("Explicit")(acc(y.f, wildcard))

  // $PrecisionTest: $READ_WRITE=xs[0].f $READ_ONLY=y.f $INVARIANT=|xs|>0 $ACC_INVARIANT=(forall$_$x:Ref::x$_$in$_$xs$_$==>$_$acc(x.f))

  @testAssertion("Explicit")
  assert xs[0] != y
}

method quantifiedExhalePartiallyTest(xs: Seq[Ref]) {
  var res: Int
  assume |xs| > 5
  inhale @dependency("Explicit")(forall x: Ref :: x in xs ==> acc(x.f))

  inhale xs[0] != xs[4]

  // $PrecisionTest: $READ_WRITE=xs[0].f,xs[4].f $INVARIANT=|xs|>0 $ACC_INVARIANT=forall$_$x:Ref::x$_$in$_$xs$_$==>$_$acc(x.f)

  @testAssertion("Explicit")
  exhale forall x: Ref :: x in xs ==> acc(x.f, 1/2)
}

method quantifiedExhalePartially(xs: Seq[Ref]) {
  var res: Int
  assume @dependency("Explicit")(|xs| > 5)
  inhale @dependency("Explicit")(forall x: Ref :: x in xs ==> acc(x.f))

  exhale forall x: Ref :: x in xs ==> acc(x.f, 1/2)

  // $PrecisionTest: $READ_WRITE=res $READ_ONLY=xs[1].f,xs[0].f,xs[2].f $INVARIANT=|xs|>0 $ACC_INVARIANT=forall$_$x:Ref::x$_$in$_$xs$_$==>$_$acc(x.f,1/2)

  @testAssertion("Implicit")
  res := xs[1].f + 1
}

method quantifiedExhaleFully(xs: Seq[Ref]) {
  assume |xs| > 5
  inhale @dependency("Explicit")(forall x: Ref :: x in xs ==> acc(x.f))

  inhale xs[0] != xs[2]

  // $PrecisionTest: $READ_WRITE=xs[0].f,xs[2].f $READ_ONLY=xs[1].f $INVARIANT=|xs|>0 $ACC_INVARIANT=|xs|>5&&forall$_$x:Ref::x$_$in$_$xs$_$==>$_$acc(x.f)

  @testAssertion("Explicit")
  exhale forall x: Ref :: x in xs ==> acc(x.f)
}

method quantifiedPermWrite1(xs: Seq[Ref]) {
  @dependency("Explicit")
  assume |xs| > 5
  @dependency("Explicit")
  inhale forall x: Ref :: x in xs ==> (acc(x.f) && x.f > 0)

  inhale xs[0] != xs[2]

  // $PrecisionTest: $READ_WRITE=xs[2].f $READ_ONLY=xs[0].f,xs[1].f $INVARIANT=xs[0].f>0 $ACC_INVARIANT=|xs|>5&&(forall$_$x:Ref::x$_$in$_$xs$_$==>$_$acc(x.f))

  @testAssertion("Implicit")
  xs[0].f := 0
}

method quantifiedPermWrite2(xs: Seq[Ref]) {
  @dependency("Explicit")
  assume |xs| > 5
  @dependency("Explicit")
  inhale forall x: Ref :: x in xs ==> (acc(x.f) && x.f > 0)

  @dependency("Implicit")
  xs[0].f := 0

  inhale xs[0] != xs[2]

  // $PrecisionTest: $READ_ONLY=xs[0].f,xs[1].f $INVARIANT=xs[0].f<3 $ACC_INVARIANT=|xs|>5&&(forall$_$x:Ref::x$_$in$_$xs$_$==>$_$acc(x.f,1/4))

  @testAssertion("Explicit")
  assert xs[0].f == 0
}

method quantifiedPermWrite3(xs: Seq[Ref]) {
  @dependency("Explicit")
  assume |xs| > 5
  @dependency("Explicit")
  inhale forall x: Ref :: x in xs ==> (acc(x.f) && x.f > 0)

  @irrelevant("Implicit")
  xs[0].f := 0

  // $PrecisionTest: $READ_WRITE=xs[0].f $READ_ONLY=xs[1].f,xs[2].f $INVARIANT=xs[1].f>=0 $ACC_INVARIANT=|xs|>1&&acc(xs[0].f,3/4)&&(forall$_$x:Ref::x$_$in$_$xs$_$==>$_$acc(x.f,1/4))

  @testAssertion("Explicit")
  assert xs[0] != xs[1] ==> xs[1].f > 0
}

method quantifiedPermWrite4(xs: Seq[Ref], ys: Seq[Ref])
  requires @dependency("Precondition")(|xs| > 5)
  requires |ys| > 3
{
  @dependency("Explicit")
  inhale forall x: Ref :: x in xs ==> acc(x.f)
  @irrelevant("Explicit")
  inhale forall y: Ref :: y in ys ==> acc(y.f)

  inhale ys[0] != ys[1]

  // $PrecisionTest: $READ_WRITE=ys[0].f,ys[1].f $READ_ONLY=xs[0].f,xs[1].f $INVARIANT=|ys|>3 $ACC_INVARIANT=|xs|>5&&|ys|>3&&(forall$_$x:Ref::x$_$in$_$xs$_$==>$_$acc(x.f))&&(forall$_$y:Ref::y$_$in$_$ys$_$==>$_$acc(y.f))

  @testAssertion("Implicit")
  xs[0].f := 2
}
